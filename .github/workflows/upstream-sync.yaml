name: Sync with Upstream

on:
  schedule:
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2 Ñ‡Ð°ÑÐ° Ð½Ð¾Ñ‡Ð¸
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if ahead of upstream'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-upstream:
    name: Check Upstream Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      commits_behind: ${{ steps.check.outputs.commits_behind }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/stackblitz-labs/bolt.diy.git || true
          git fetch upstream

      - name: Check for updates
        id: check
        run: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð², Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ñ‹ Ð¾Ñ‚ÑÑ‚Ð°Ñ‘Ð¼
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "commits_behind=$BEHIND" >> $GITHUB_OUTPUT
          
          if [ "$BEHIND" -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "ðŸ”” ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ $BEHIND Ð½Ð¾Ð²Ñ‹Ñ… ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð² Ð² upstream"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð°ÐºÑ‚ÑƒÐ°Ð»ÐµÐ½"
          fi

      - name: Get upstream changes summary
        if: steps.check.outputs.has_updates == 'true'
        run: |
          echo "## ðŸ“‹ Upstream Changes" > upstream-changes.md
          echo "" >> upstream-changes.md
          git log --oneline HEAD..upstream/main --pretty=format:"- %s (%h)" >> upstream-changes.md
          cat upstream-changes.md

      - name: Upload changes summary
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: upstream-changes
          path: upstream-changes.md

  create-sync-pr:
    name: Create Sync PR
    needs: check-upstream
    runs-on: ubuntu-latest
    if: needs.check-upstream.outputs.has_updates == 'true' || github.event.inputs.force_sync == 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add and fetch upstream
        run: |
          git remote add upstream https://github.com/stackblitz-labs/bolt.diy.git || true
          git fetch upstream

      - name: Create sync branch
        run: |
          BRANCH_NAME="sync-upstream-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME

      - name: Merge upstream changes
        run: |
          # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ merge
          if git merge upstream/main --no-edit; then
            echo "MERGE_STATUS=success" >> $GITHUB_ENV
            echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ merge"
          else
            echo "MERGE_STATUS=conflicts" >> $GITHUB_ENV
            echo "âš ï¸ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ñ‹"
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
            git diff --name-only --diff-filter=U > conflicts.txt
            echo "CONFLICTS<<EOF" >> $GITHUB_ENV
            cat conflicts.txt >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # ÐŸÑ€ÐµÑ€Ñ‹Ð²Ð°ÐµÐ¼ merge Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ PR Ñ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð°Ð¼Ð¸
            git merge --abort
            
            # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²ÐµÑ‚ÐºÑƒ Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¾Ð¹ merge
            git merge upstream/main --no-commit || true
          fi

      - name: Push sync branch
        run: |
          git push -u origin ${{ env.BRANCH_NAME }}

      - name: Download upstream changes
        uses: actions/download-artifact@v4
        with:
          name: upstream-changes
        continue-on-error: true

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let body = '## ðŸ”„ Sync with Upstream Repository\n\n';
            body += 'This PR syncs changes from the upstream repository.\n\n';
            body += `**Commits behind**: ${{ needs.check-upstream.outputs.commits_behind }}\n\n`;
            
            // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
            try {
              const changes = fs.readFileSync('upstream-changes.md', 'utf8');
              body += changes + '\n\n';
            } catch (e) {
              body += 'Unable to load changes summary.\n\n';
            }
            
            if ('${{ env.MERGE_STATUS }}' === 'conflicts') {
              body += '### âš ï¸ Merge Conflicts Detected\n\n';
              body += 'The following files have conflicts:\n\n';
              body += '```\n${{ env.CONFLICTS }}\n```\n\n';
              body += 'Please resolve conflicts manually before merging.\n\n';
            } else {
              body += '### âœ… Auto-merge Successful\n\n';
              body += 'No conflicts detected. Ready to merge.\n\n';
            }
            
            body += '---\n';
            body += '*Automatically generated by upstream-sync workflow*';
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”„ Sync with upstream repository',
              head: '${{ env.BRANCH_NAME }}',
              base: 'main',
              body: body,
              draft: '${{ env.MERGE_STATUS }}' === 'conflicts'
            });
            
            // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚ÐºÐ¸
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['sync', 'upstream', 'automated']
            });
            
            console.log(`Created PR #${pr.number}`);

      - name: Summary
        run: |
          echo "## ðŸ”„ Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ env.BRANCH_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits Behind**: ${{ needs.check-upstream.outputs.commits_behind }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge Status**: ${{ env.MERGE_STATUS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ env.MERGE_STATUS }}" = "conflicts" ]; then
            echo "âš ï¸ Manual intervention required to resolve conflicts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Ready to merge" >> $GITHUB_STEP_SUMMARY
          fi

  notify-maintainers:
    name: Notify Maintainers
    needs: [check-upstream, create-sync-pr]
    runs-on: ubuntu-latest
    if: needs.check-upstream.outputs.has_updates == 'true' && needs.create-sync-pr.result == 'success'
    
    steps:
      - name: Create notification issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ðŸ”” Upstream Sync Available
            
            A new sync PR has been created to merge upstream changes.
            
            **Commits to sync**: ${{ needs.check-upstream.outputs.commits_behind }}
            
            Please review the PR and merge when ready.
            
            ---
            *This issue was automatically created by upstream-sync workflow*`;
            
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”„ Upstream sync available',
              body: body,
              labels: ['sync', 'notification']
            });
            
            console.log(`Created issue #${issue.number}`);
